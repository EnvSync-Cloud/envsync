services:
  # envsync_api:
  #   build:
  #     context: packages/envsync-api
  #     dockerfile: Dockerfile
  #   env_file:
  #     - .env
  #   ports:
  #     - "${PORT:-4000}:${PORT:-4000}"
  #   restart: always
  #   environment:
  #     KEYCLOAK_URL: http://keycloak:8080
  #   depends_on:
  #     - keycloak
  #     - redis
  #     - rustfs
  #     - mailpit
  #     - spacetimedb
  #   networks:
  #     - envsync_network

  spacetimedb:
    image: clockworklabs/spacetime:latest
    profiles: ["stdb"]
    ports:
      - "${STDB_PORT:-1234}:3000"
      - "${STDB_PG_PORT:-5432}:5432"
    restart: always
    command: ["start", "--pg-port", "${STDB_PG_PORT:-5432}"]
    volumes:
      - stdb_data:/stdb
    environment:
      SPACETIMEDB_LOG_LEVEL: info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/v1/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - envsync_network

  stdb_publish:
    build:
      context: packages/envsync-stdb
      dockerfile: Dockerfile
    profiles: ["stdb"]
    depends_on:
      spacetimedb:
        condition: service_healthy
    networks:
      - envsync_network
    restart: "no"

  rustfs:
    image: rustfs/rustfs:latest
    ports:
      - "${RUSTFS_PORT:-19000}:9000"
      - "${RUSTFS_HTTP_PORT:-19001}:9001"
    restart: always
    volumes:
      - rustfs_data:/data
    environment:
      RUSTFS_DATA_DIR: /data
      RUSTFS_ACCESS_KEY: ${RUSTFS_ACCESS_KEY:-rustfsadmin}
      RUSTFS_SECRET_KEY: ${RUSTFS_SECRET_KEY:-rustfsadmin}
      RUSTFS_CONSOLE_ENABLE: "true"
    networks:
      - envsync_network

  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    restart: unless-stopped
    volumes:
      - mailpit_data:/data
    ports:
      - "${MAILPIT_PORT:-8025}:8025"
      - "${MAILPIT_SMTP_PORT:-1025}:1025"
    environment:
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - envsync_network

  # Keycloak DB: PostgreSQL for Keycloak's own storage only
  keycloak_db:
    image: postgres:17
    restart: unless-stopped
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
      POSTGRES_DB: keycloak
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - envsync_network

  keycloak:
    image: quay.io/keycloak/keycloak:26.1
    command: ["start-dev", "--import-realm"]
    restart: unless-stopped
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak_db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-localhost}
      KC_HTTP_ENABLED: "true"
      KC_FEATURES: device-flow
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    volumes:
      - ./docker/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200'"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    depends_on:
      keycloak_db:
        condition: service_healthy
    networks:
      - envsync_network

  # --- Observability Stack (Grafana LGTM) ---
  tempo:
    image: grafana/tempo:2.6.1
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./docker/otel/tempo-config.yaml:/etc/tempo.yaml:ro
      - tempo_data:/var/tempo
    ports:
      - "${TEMPO_PORT:-3200}:3200"
    networks:
      - envsync_network

  loki:
    image: grafana/loki:3
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - ./docker/otel/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    networks:
      - envsync_network

  prometheus:
    image: prom/prometheus:latest
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-remote-write-receiver"
    volumes:
      - ./docker/otel/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - envsync_network

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./docker/otel/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "${OTEL_COLLECTOR_GRPC_PORT:-4317}:4317"
      - "${OTEL_COLLECTOR_HTTP_PORT:-4318}:4318"
      - "8888:8888"
      - "13133:13133"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "2"
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      tempo:
        condition: service_started
      loki:
        condition: service_started
      prometheus:
        condition: service_healthy
    networks:
      - envsync_network

  promtail:
    image: grafana/promtail:3
    command: ["-config.file=/etc/promtail/config.yaml"]
    volumes:
      - ./docker/otel/promtail-config.yaml:/etc/promtail/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      loki:
        condition: service_started
    networks:
      - envsync_network

  grafana:
    image: grafana/grafana:latest
    ports:
      - "${GRAFANA_PORT:-3302}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-EnvSync@2024!}
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/otel/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/otel/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      prometheus:
        condition: service_healthy
      tempo:
        condition: service_started
      loki:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - envsync_network

  redis:
    image: ghcr.io/envsync-cloud/chabi:0.1.0-rc3
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - envsync_network
    volumes:
      - redis_data:/data

  httpbin:
    image: kong/httpbin:latest
    ports:
      - "${HTTPBIN_PORT:-8181}:80"
    networks:
      - envsync_network

  # --- HyperDX (Session Replay + Observability) ---
  hdx:
    image: clickhouse/clickstack-all-in-one:latest
    volumes:
      - hdx_data:/data/db
      - hdx_ch_data:/var/lib/clickhouse
      - hdx_ch_logs:/var/log/clickhouse-server
    restart: unless-stopped
    environment:
      - OTEL_AGENT_FEATURE_GATE_ARG='--feature-gates=clickhouse.json'
      - BETA_CH_OTEL_JSON_SCHEMA_ENABLED=true
    ports:
      - "${HDX_PORT:-8800}:8080"
      - "${HDX_OTEL_GRPC_PORT:-4316}:4317"
      - "${HDX_OTEL_PORT:-4319}:4318"
    networks:
      - envsync_network

networks:
  envsync_network:
    driver: bridge

volumes:
  redis_data:
  mailpit_data:
  stdb_data:
  rustfs_data:
  keycloak_db_data:
  tempo_data:
  loki_data:
  prometheus_data:
  grafana_data:
  hdx_data:
  hdx_ch_data:
  hdx_ch_logs:
