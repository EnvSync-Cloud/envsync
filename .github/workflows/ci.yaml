name: Build & Test

on:
  push:
    branches:
      - main
      - dev
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
      - run: bun i
      - run: bun run build

  build-cli:
    name: Build CLI (Go)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: packages/envsync-cli/go.sum
      - name: Build CLI binary
        run: go build -ldflags="-s -w" -o /dev/null ./cmd/cli/main.go
        working-directory: packages/envsync-cli
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
      - name: Run go vet
        run: go vet ./...
        working-directory: packages/envsync-cli

  test-mock:
    name: Mock Tests
    runs-on: ubuntu-latest
    env:
      CACHE_ENV: development
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
      - run: bun i
      - name: Run mock tests
        run: bun run test:mock
        working-directory: packages/envsync-api

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    services:
      keycloak-db:
        image: postgres:17
        env:
          POSTGRES_USER: keycloak
          POSTGRES_PASSWORD: keycloak
          POSTGRES_DB: keycloak
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U keycloak"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    env:
      CACHE_ENV: production
      REDIS_URL: redis://localhost:6379
      STDB_URL: http://localhost:1234
      STDB_DB_NAME: envsync-e2e
      STDB_ROOT_KEY: ci-e2e-root-key
      KEYCLOAK_URL: http://localhost:8080
      KEYCLOAK_REALM: envsync
      KEYCLOAK_ADMIN_USER: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      SKIP_ROOT_ENV: "1"
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
      - name: Setup Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: packages/envsync-cli/go.sum
      - run: bun i

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install SpacetimeDB CLI
        run: |
          curl -fsSL https://install.spacetimedb.com | bash
          echo "$HOME/.spacetimedb/bin" >> $GITHUB_PATH

      - name: Start SpacetimeDB
        run: |
          spacetimedb start --listen-addr 0.0.0.0:1234 &
          for i in $(seq 1 30); do
            if curl -sf http://localhost:1234/database/ping > /dev/null 2>&1; then
              echo "SpacetimeDB is ready"
              break
            fi
            echo "Waiting for SpacetimeDB... ($i/30)"
            sleep 2
          done

      - name: Build and publish STDB module
        run: |
          cd packages/envsync-stdb
          spacetimedb publish envsync-e2e --server http://localhost:1234

      - name: Start Keycloak
        run: |
          docker run -d --name keycloak --network host \
            -e KC_DB=postgres \
            -e KC_DB_URL=jdbc:postgresql://localhost:5432/keycloak \
            -e KC_DB_USERNAME=keycloak \
            -e KC_DB_PASSWORD=keycloak \
            -e KC_HOSTNAME=localhost \
            -e KC_HTTP_ENABLED=true \
            -e KC_FEATURES=device-flow \
            -e KEYCLOAK_ADMIN=admin \
            -e KEYCLOAK_ADMIN_PASSWORD=admin \
            -v ${{ github.workspace }}/docker/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro \
            quay.io/keycloak/keycloak:26.1 start-dev --import-realm

      - name: Wait for Keycloak to be ready
        run: |
          for i in $(seq 1 60); do
            if curl -sf http://localhost:8080/realms/envsync/.well-known/openid-configuration > /dev/null 2>&1; then
              echo "Keycloak is ready"
              exit 0
            fi
            echo "Waiting for Keycloak... ($i/60)"
            sleep 5
          done
          echo "Keycloak failed to start"
          docker logs keycloak
          exit 1

      - name: Bootstrap Keycloak for E2E
        run: |
          bun -e "
            import { createKeycloakTestUser } from './packages/envsync-api/tests/e2e/helpers/keycloak-bootstrap';
            const user = await createKeycloakTestUser();
            console.log('Keycloak E2E user created: ' + user.id);
          "

      - name: Start Mailpit
        run: |
          docker run -d --name mailpit --network host \
            axllent/mailpit:latest \
            --smtp 0.0.0.0:1025 \
            --listen 0.0.0.0:8025

      - name: Wait for Mailpit to be ready
        run: |
          for i in $(seq 1 15); do
            if curl -sf http://localhost:8025/ > /dev/null 2>&1; then
              echo "Mailpit is ready"
              exit 0
            fi
            echo "Waiting for Mailpit... ($i/15)"
            sleep 2
          done
          echo "Mailpit failed to start"
          docker logs mailpit
          exit 1

      - name: Run E2E tests
        run: bun run test:e2e
        working-directory: packages/envsync-api
        env:
          KEYCLOAK_WEB_CLIENT_ID: envsync-web
          KEYCLOAK_CLI_CLIENT_ID: envsync-cli
          KEYCLOAK_API_CLIENT_ID: envsync-api

  build-api-image:
    name: Build & Push API Image
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/envsync-cloud/envsync-api
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: packages/envsync-api
          file: packages/envsync-api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
